# üí∞ AFP Finance App - Personal Finance with AI-Powered Email Analysis

Una aplicaci√≥n de finanzas personales que revoluciona el manejo de presupuestos mediante la
detecci√≥n autom√°tica de transacciones a trav√©s del an√°lisis inteligente de emails bancarios.

## üèóÔ∏è Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ    ‚îÇ    Supabase      ‚îÇ    ‚îÇ   Railway Service   ‚îÇ
‚îÇ   (Railway)     ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ   (Node.js + Redis) ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ  ‚Ä¢ Auth          ‚îÇ    ‚îÇ                     ‚îÇ
‚îÇ  ‚Ä¢ Vite + React‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ  ‚Ä¢ PostgreSQL    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ  ‚Ä¢ Gmail API        ‚îÇ
‚îÇ  ‚Ä¢ PWA          ‚îÇ    ‚îÇ  ‚Ä¢ Real-time     ‚îÇ    ‚îÇ  ‚Ä¢ OpenAI           ‚îÇ
‚îÇ  ‚Ä¢ TypeScript   ‚îÇ    ‚îÇ  ‚Ä¢ Row Security  ‚îÇ    ‚îÇ  ‚Ä¢ BullMQ Jobs      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ Estructura del Monorepo

```
AFP_V2/
‚îú‚îÄ‚îÄ README.md                         # Este archivo
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ package.json                      # Scripts globales del workspace
‚îú‚îÄ‚îÄ pnpm-workspace.yaml              # Configuraci√≥n del workspace
‚îÇ
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ web/                          # Frontend PWA (Deploy: Railway)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ railway.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manifest.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pwa-192x192.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pwa-512x512.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Transactions/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Budget/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Settings/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ useTransactions.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ useBudget.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ useOfflineSync.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pwa.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ api.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ authStore.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ transactionStore.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ budgetStore.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ formatters.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ validators.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ constants.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ types/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ email-service/                # Microservicio Node.js (Deploy: Railway)
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îú‚îÄ‚îÄ railway.json
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ server.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ app.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emailController.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transactionController.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ healthController.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gmailService.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ aiService.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transactionService.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabaseService.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ jobs/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emailProcessor.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ aiTraining.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scheduler.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ encryption.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ regex.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gmail.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ       ‚îî‚îÄ‚îÄ Dockerfile
‚îÇ
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ shared-types/                 # Types compartidos entre apps
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ database.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ transactions.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ budget.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ ui-components/                # Componentes UI reutilizables
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tailwind.config.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Button/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Modal/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Charts/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Forms/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ supabase/                     # Configuraci√≥n y schema de Supabase
‚îÇ       ‚îú‚îÄ‚îÄ config.toml
‚îÇ       ‚îú‚îÄ‚îÄ seed.sql
‚îÇ       ‚îî‚îÄ‚îÄ migrations/
‚îÇ           ‚îú‚îÄ‚îÄ 20241001000001_initial_schema.sql
‚îÇ           ‚îú‚îÄ‚îÄ 20241001000002_rls_policies.sql
‚îÇ           ‚îî‚îÄ‚îÄ 20241001000003_functions.sql
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ setup.sh                     # Setup inicial del proyecto
‚îÇ   ‚îú‚îÄ‚îÄ dev.sh                       # Iniciar desarrollo local
‚îÇ   ‚îú‚îÄ‚îÄ build.sh                     # Build de producci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ deploy.sh                    # Deploy a Railway
‚îÇ   ‚îî‚îÄ‚îÄ db-reset.sh                  # Reset de base de datos local
‚îÇ
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email-service.md
‚îÇ   ‚îú‚îÄ‚îÄ deployment/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ railway.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.md
‚îÇ   ‚îî‚îÄ‚îÄ development/
‚îÇ       ‚îú‚îÄ‚îÄ getting-started.md
‚îÇ       ‚îî‚îÄ‚îÄ contributing.md
‚îÇ
‚îî‚îÄ‚îÄ tasks/                           # PRDs y documentaci√≥n de tareas
    ‚îî‚îÄ‚îÄ 0001-prd-personal-finance-app.md
```

## üîÑ Flujo de Datos y Procesos

### 1. **Flujo de Autenticaci√≥n**

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant S as Supabase
    participant E as Email Service

    U->>F: Login/Register
    F->>S: Auth request
    S-->>F: JWT Token + User data
    F->>E: Connect Gmail (with JWT)
    E->>Gmail: OAuth flow
    Gmail-->>E: Access/Refresh tokens
    E->>S: Store encrypted tokens
```

### 2. **Flujo de Procesamiento de Emails**

```mermaid
sequenceDiagram
    participant C as Cron Job
    participant E as Email Service
    participant G as Gmail API
    participant AI as OpenAI
    participant S as Supabase
    participant F as Frontend

    C->>E: Trigger hourly processing
    E->>G: Fetch new emails
    G-->>E: Email list
    E->>AI: Generate/improve regex patterns
    AI-->>E: Regex templates
    E->>E: Extract transaction data
    E->>S: Save transactions
    S-->>F: Real-time update (via subscription)
```

### 3. **Flujo de Gesti√≥n de Presupuesto**

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant S as Supabase

    U->>F: Create budget category
    F->>S: Insert category
    S-->>F: Real-time confirmation

    Note over S: New transaction detected
    S->>F: Real-time transaction update
    F->>F: Check budget limits
    F->>U: Show alert if over limit
```

## üöÄ Stack Tecnol√≥gico

### **Frontend (PWA)**

- **Build Tool:** Vite 4+ - Build r√°pido y HMR instant√°neo
- **Framework:** React 18+ con TypeScript - Type safety y componentes modernos
- **PWA:** vite-plugin-pwa - Service worker autom√°tico y manifest
- **State:** Zustand - State management ligero y simple
- **Styling:** Tailwind CSS - Utility-first CSS framework
- **Charts:** Recharts - Gr√°ficos financieros interactivos
- **HTTP:** Supabase client - Real-time y REST API

### **Backend (Microservicio)**

- **Runtime:** Node.js 18+ con TypeScript - Performance y type safety
- **Framework:** Fastify - HTTP server de alta performance
- **Jobs:** BullMQ + Redis - Background jobs y scheduling
- **Email:** googleapis - Integraci√≥n nativa con Gmail
- **AI:** OpenAI SDK - Generaci√≥n de regex patterns
- **Database:** Supabase client con service role - Bypass RLS
- **Validation:** Zod - Runtime type validation
- **Logging:** Winston - Structured logging

### **Infrastructure**

- **Deployment:** Railway - Platform-as-a-Service con CI/CD
- **Database:** Supabase PostgreSQL - Managed database con RLS
- **Cache/Queue:** Railway Redis - Para BullMQ jobs
- **Auth:** Supabase Auth - OAuth y JWT management
- **Monitoring:** Railway metrics + Winston logs

## üõ†Ô∏è Setup y Desarrollo

### **Prerrequisitos**

- Node.js 18+
- pnpm 8+
- Cuenta en Supabase
- Cuenta en Railway
- Cuenta en Google Cloud (para Gmail API)

### **Instalaci√≥n**

```bash
# Clonar el repositorio
git clone <repo-url>
cd AFP_V2

# Instalar dependencias
pnpm install

# Configurar variables de entorno
cp .env.example .env
# Editar .env con tus credenciales

# Setup inicial
pnpm run setup

# Iniciar desarrollo
pnpm run dev
```

### **Scripts Disponibles**

```bash
# Desarrollo
pnpm run dev              # Inicia frontend y backend en modo desarrollo
pnpm run dev:web          # Solo frontend
pnpm run dev:api          # Solo backend

# Build
pnpm run build            # Build de producci√≥n para ambas apps
pnpm run build:web        # Build solo frontend
pnpm run build:api        # Build solo backend

# Testing
pnpm run test             # Tests de todas las apps
pnpm run test:web         # Tests del frontend
pnpm run test:api         # Tests del backend

# Database
pnpm run db:reset         # Reset database local
pnpm run db:migrate       # Ejecutar migraciones
pnpm run db:seed          # Seed data de desarrollo

# Deployment
pnpm run deploy           # Deploy a Railway
pnpm run deploy:web       # Deploy solo frontend
pnpm run deploy:api       # Deploy solo backend
```

## üîê Variables de Entorno

### **Frontend (.env)**

```bash
# Supabase
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# Email Service
VITE_EMAIL_SERVICE_URL=https://your-service.up.railway.app

# App Config
VITE_APP_NAME="AFP Finance"
VITE_APP_VERSION="1.0.0"
```

### **Backend (.env)**

```bash
# Server
PORT=8080
NODE_ENV=development

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Gmail API
GMAIL_CLIENT_ID=your-gmail-client-id
GMAIL_CLIENT_SECRET=your-gmail-client-secret
GMAIL_REDIRECT_URI=http://localhost:8080/auth/gmail/callback

# OpenAI
OPENAI_API_KEY=your-openai-key

# Redis (Railway managed)
REDIS_URL=redis://localhost:6379

# Security
JWT_SECRET=your-jwt-secret
ENCRYPTION_KEY=your-32-char-encryption-key
```

## üìä Caracter√≠sticas Principales

### **ü§ñ Detecci√≥n Autom√°tica de Transacciones**

- An√°lisis de emails bancarios cada hora
- Regex patterns generados por AI
- Soporte para m√∫ltiples bancos y tarjetas
- Feedback loop para mejorar precisi√≥n

### **üí∞ Gesti√≥n de Presupuestos**

- Categor√≠as personalizables
- L√≠mites mensuales por categor√≠a
- Alertas en tiempo real
- Reportes y an√°lisis de tendencias

### **üì± Progressive Web App**

- Funciona offline
- Instalable en dispositivos m√≥viles
- Push notifications para alertas
- Sync autom√°tico cuando vuelve online

### **üîí Seguridad y Privacidad**

- Tokens de email encriptados
- No almacenamiento de emails raw
- Row Level Security en Supabase
- Comunicaci√≥n HTTPS/TLS

## üöÄ Roadmap

### **Fase 1: MVP (Actual)**

- ‚úÖ Autenticaci√≥n con Supabase
- ‚úÖ Conexi√≥n con Gmail
- ‚úÖ Detecci√≥n b√°sica de transacciones
- ‚úÖ Gesti√≥n de presupuestos
- ‚úÖ PWA b√°sica

### **Fase 2: Mejoras**

- üîÑ M√∫ltiples proveedores de email
- üîÑ Categorizaci√≥n autom√°tica mejorada
- üîÑ Reportes avanzados
- üîÑ Exportaci√≥n de datos

### **Fase 3: Expansi√≥n**

- üìã Integraci√≥n con APIs bancarias
- üìã Soporte para m√∫ltiples monedas
- üìã Cuentas familiares compartidas
- üìã Integraci√≥n con servicios de inversi√≥n

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/amazing-feature`)
3. Commit tus cambios (`git commit -m 'Add amazing feature'`)
4. Push a la rama (`git push origin feature/amazing-feature`)
5. Abre un Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la licencia MIT. Ver `LICENSE` para m√°s detalles.

## üìû Soporte

- üìß Email: support@afp-finance.com
- üí¨ Discord: [AFP Finance Community](https://discord.gg/afp-finance)
- üìö Docs: [docs.afp-finance.com](https://docs.afp-finance.com)

---

**Hecho con ‚ù§Ô∏è para revolucionar las finanzas personales**
# Railway deployment fix
